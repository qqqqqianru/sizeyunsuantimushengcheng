#include<math.h>
#include<stdio.h>
#include<stdlib.h>
#include<iostream>

char *calculate(char * timu,int kuohao,int chengfang,int chengchu,int jiajian)//递归计算 四个int变量指示括号、乘方、乘除、加减数量
{
	int len = strlen(timu);
	if (kuohao)
	{
		int lpos = 0,rpos = 0;
		for (int i = 0;i <= len;i++)//有括号时获取括号位置
		{
			if (timu[i] == '(')
			{
				lpos = i;
			}
			if (timu[i] == ')')
			{
				rpos = i;
				break;
			}
		}
		char ret[100];					//要返回的数组
		char newtimu[100];				//要参与递归的数组
		memset(newtimu, '\0', sizeof(newtimu));
		memset(ret, '\0', sizeof(ret));
		for (int i = 0;i < lpos;i++)
		{
			ret[i] = timu[i];
		}
		for (int i = lpos+1;i < rpos-1;i++)
		{
			newtimu[lpos - i + 1] = timu[i];
		}
		kuohao--;
		int kuohao2=0, chengfang2=0, chengchu2=0, jiajian2=0;//统计括号内的运算符
		for (int i = lpos+1;i < rpos ;i++)//获得运算符个数
		{
			if (timu[i] == '+' || timu[i] == '-')
			{
				jiajian2++;
			}
			else if (timu[i] == '*' || timu[i] == '/')
			{
				chengchu2++;
			}
			else if (timu[i] == '^')
			{
				chengfang2++;
			}
			else if (timu[i] == '(')
			{
				kuohao2++;
			}
		}
		strcat(ret, calculate(newtimu, kuohao2, chengfang2, chengchu2, jiajian2));//进行递归
		int retlen = strlen(ret);
		for (int i = 0;i < len - rpos - 1;i++)
		{
			ret[retlen + i] = timu[rpos + i + 1];
		}
		return ret;
	}
	else if (chengfang)
	{
		int cpos = 0;
		char leftnum[10];
		int leftlen = 0;
		memset(leftnum, '\0', sizeof(leftnum));
		int leftstart=-1;//左边数字的起始位置
		for (int i = 0;i <= len;i++)//有乘方时获取乘方位置,并获取乘方符号左边数
		{
			if (timu[i] == '^')
			{
				cpos = i;
				break;
			}
			else if ('0' <= timu[i] && timu[i] <= '9')
			{
				if (leftstart == -1)leftstart = i;
				leftnum[leftlen++] = timu[i];
			}
			else if (timu[i] == '+' || timu[i] == '-' || timu[i] == '*' || timu[i] == '/')
			{
				leftlen = 0;
				leftstart = -1;
				memset(leftnum, '\0', sizeof(leftnum));
			}

		}
		char rightnum[10];
		int rightlen = 0;int rightop = -1;
		memset(rightnum, '\0', sizeof(rightnum));
		for (int i = cpos + 1;i < len;i++)//获取乘方符号右边的数字
		{
			if ('0' <= timu[i] && timu[i] <= '9')
			{
				rightnum[rightlen++] = timu[i];
			}
			else if (timu[i] == '+' || timu[i] == '-' || timu[i] == '*' || timu[i] == '/'||timu[i]=='^')
			{
				rightop = i;
				break;
			}
		}
		
		//进行计算
		int l = atoi(leftnum);int r = atoi(rightnum);int temp = l;
		for (int i = 1;i <= r;i++)
			l = l * temp;
		
		char res[100];
		char newtimu[100];
		memset(newtimu, '\0', sizeof(newtimu));
		memset(res, '\0', sizeof(res));

		itoa(l,res,10);
		if ((!(jiajian)) && (!(chengchu)))return res;
		for (int i = 0;i < leftstart;i++)
		{
			newtimu[i] = timu[i];
		}
		strcat(newtimu, res);
		if (rightop != -1)
		{
			int newtimulen = strlen(newtimu);
			for (int i = 0;i < len - rightop;i++)
			{
				newtimu[newtimulen + i] = timu[rightop + i];		//计算完成确定新题目
			}
		}
		//乘方数量减一进行递归
		chengfang--;
		return calculate(newtimu, kuohao, chengfang, chengchu, jiajian);
	}
	else if (chengchu)
	{
	int cpos = 0;
	int op = -1;//op代表乘或除
	char leftnum[10];
	int leftlen = 0;
	memset(leftnum, '\0', sizeof(leftnum));
	int leftstart = -1;//左边数字的起始位置
	for (int i = 0;i <= len;i++)//有乘除时获取乘除位置,并获取符号左边数
	{
		if (timu[i] == '*')
		{
			cpos = i;
			op = 1;
			break;
		}
		else if (timu[i] == '/')
		{
			cpos = i;
			op = 2;
			break;
		}
		else if ('0' <= timu[i] && timu[i] <= '9')
		{
			if (leftstart == -1)leftstart = i;
			leftnum[leftlen++] = timu[i];
		}
		else if (timu[i] == '+' || timu[i] == '-' )
		{
			leftlen = 0;
			leftstart = -1;
			memset(leftnum, '\0', sizeof(leftnum));
		}

	}
	char rightnum[10];
	int rightlen = 0;int rightop = -1;
	memset(rightnum, '\0', sizeof(rightnum));
	for (int i = cpos + 1;i < len;i++)//获取符号右边的数字
	{
		if ('0' <= timu[i] && timu[i] <= '9')
		{
			rightnum[rightlen++] = timu[i];
		}
		else if (timu[i] == '+' || timu[i] == '-' || timu[i] == '*' || timu[i] == '/' || timu[i] == '^')
		{
			rightop = i;
			break;
		}
	}

	//进行计算
	char res[100];
	memset(res, '\0', sizeof(res));
	char newtimu[100];
	memset(newtimu, '\0', sizeof(newtimu));
	int l = atoi(leftnum);
	int r = atoi(rightnum);
	int result = 0;
	int fenshu = 0;//表示能否除尽
	if (leftstart == 0)//左边运算数在开头，不需考虑分数
	{
		if (op == 1)
		{
			result = l * r;
		}
		else
		{
			if (l%r == 0)//能除尽 直接计算
			{
				result = l / r;
			}
			else//不能除尽，化为分数
			{
				timu[cpos] = '#';//以#号代表不能除尽的分数
				char newtimu[100];
				memset(newtimu, '\0', sizeof(newtimu));
				strcpy(newtimu, timu);
				return calculate(newtimu, kuohao, chengfang, chengchu, jiajian);
			}
		}
	}
	else//需要考虑运算符左边是否为分数，由于顺序运算，不需考虑右边是否为分数
	{
		if (timu[leftstart - 1] == '#')
		{
			char leftfenzi[10];int fenzistart = -1,fenzilen = 0;//获得分子的值和起始位置
			for (int i = 0;i < leftstart - 1;i++)
			{
				if ('0' <= timu[i] && timu[i] <= '9')
				{
					if (fenzistart == -1)fenzistart = i;
					leftfenzi[fenzilen++] = timu[i];
				}
				else if (timu[i] == '+' || timu[i] == '-')
				{
					fenzilen = 0;
					fenzistart = -1;
					memset(leftfenzi, '\0', sizeof(leftfenzi));
				}
			}
			int fenzi = atoi(leftfenzi);

			if (op == 1)
			{
				fenzi = fenzi * r;
				if (fenzi%l == 0)
				{
					result = fenzi / l;
				}
				else
				{

				}
			}

		}
		else
		{
			if (op == 1)
			{
				result = l * r;
				itoa(result, res, 10);
				for (int i = 0;i < leftstart;i++)
				{
					newtimu[i] = timu[i];
				}
				strcat(newtimu, res);
				if (rightop != -1)
				{
					int newtimulen = strlen(newtimu);
					for (int i = 0;i < len - rightop;i++)
					{
						newtimu[newtimulen + i] = timu[rightop + i];		//计算完成确定新题目
					}
				}
			}
			else
			{
				if (l%r == 0)//能除尽 直接计算
				{
					result = l / r;
					itoa(result, res, 10);
					for (int i = 0;i < leftstart;i++)
					{
						newtimu[i] = timu[i];
					}
					strcat(newtimu, res);
					if (rightop != -1)
					{
						int newtimulen = strlen(newtimu);
						for (int i = 0;i < len - rightop;i++)
						{
							newtimu[newtimulen + i] = timu[rightop + i];		//计算完成确定新题目
						}
					}
				}
				else//不能除尽，化为分数
				{
					timu[cpos] = '#';//以#号代表不能除尽的分数
					char newtimu[100];
					memset(newtimu, '\0', sizeof(newtimu));
					strcpy(newtimu, timu);
					chengchu--;
					return calculate(newtimu, kuohao, chengfang, chengchu, jiajian);
				}
			}
		}
	}

	
	

	
	//乘除数量减一进行递归
	chengchu--;
	return calculate(newtimu, kuohao, chengfang, chengchu, jiajian);
	}
	else if (jiajian)
	{
		;
	}
}

char * jieti(int mode,char *timu)
{
	int len = strlen(timu);
	int kuohao = 0, chengfang = 0, chengchu = 0,jiajian=0;
	if (mode == 2)//如果以**表示乘方则转化为^
	{
		for (int i = 0;i < len-1;i++)
		{
			if (timu[i] == '*'&&timu[i + 1] == '*')
			{
				timu[i] = '^';
				timu[i + 1] = ' ';
			}
		}
	}
	for (int i = 0;i < len - 1;i++)//获得运算符个数
	{
		if (timu[i] == '+'||timu[i]=='-')
		{
			jiajian++;
		}
		else if(timu[i] == '*' || timu[i] == '/')
		{
			chengchu++;
		}
		else if (timu[i] == '^')
		{
			chengfang++;
		}
		else if (timu[i] == '(')
		{
			kuohao++;
		}
	}
	return calculate(timu,kuohao,chengfang,chengchu,jiajian);//递归计算

	return 0;
}
